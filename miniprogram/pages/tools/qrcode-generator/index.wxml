<view class="container">
  <!-- Custom Navigation Bar -->
  <view class="custom-nav">
    <view class="nav-back" bindtap="goBack">
      <text class="nav-back-icon">â†</text>
    </view>
    <view class="nav-title">äºŒç»´ç ç”Ÿæˆå™¨</view>
  </view>

  <!-- Type Selection -->
  <view class="type-selector">
    <view class="type-option {{qrCodeType === 'text' ? 'active' : ''}}" bindtap="selectQRCodeType" data-type="text">
      <text>æ–‡æœ¬</text>
    </view>
    <view class="type-option {{qrCodeType === 'url' ? 'active' : ''}}" bindtap="selectQRCodeType" data-type="url">
      <text>ç½‘å€</text>
    </view>
    <view class="type-option {{qrCodeType === 'wifi' ? 'active' : ''}}" bindtap="selectQRCodeType" data-type="wifi">
      <text>WiFi</text>
    </view>
    <view class="type-option {{qrCodeType === 'contact' ? 'active' : ''}}" bindtap="selectQRCodeType" data-type="contact">
      <text>è”ç³»äºº</text>
    </view>
  </view>

  <!-- Content Input Section -->
  <view class="input-section">
    <block wx:if="{{qrCodeType === 'text'}}">
      <textarea
        class="content-input"
        placeholder="è¾“å…¥è¦ç”ŸæˆäºŒç»´ç çš„æ–‡æœ¬å†…å®¹"
        value="{{content}}"
        bindinput="onContentInput"
        maxlength="{{contentMaxLength}}"
      ></textarea>
      <view class="char-count">{{content.length}}/{{contentMaxLength}}</view>
    </block>

    <block wx:elif="{{qrCodeType === 'url'}}">
      <input
        class="content-input url-input"
        placeholder="è¾“å…¥ç½‘å€"
        value="{{content}}"
        bindinput="onContentInput"
      />
      <view class="hint-text">è‡ªåŠ¨æ·»åŠ  https:// å‰ç¼€ï¼ˆå¦‚æœªè¾“å…¥ï¼‰</view>
    </block>

    <block wx:elif="{{qrCodeType === 'wifi'}}">
      <view class="form-item">
        <text class="form-label">WiFiåç§°</text>
        <input
          class="form-input"
          placeholder="è¾“å…¥WiFiåç§°"
          value="{{wifiData.ssid}}"
          bindinput="onWifiSSIDInput"
        />
      </view>
      <view class="form-item">
        <text class="form-label">å¯†ç </text>
        <input
          class="form-input"
          placeholder="è¾“å…¥WiFiå¯†ç "
          value="{{wifiData.password}}"
          bindinput="onWifiPasswordInput"
          password="{{true}}"
        />
      </view>
      <view class="form-item">
        <text class="form-label">åŠ å¯†ç±»å‹</text>
        <picker
          bindchange="onWifiEncryptionChange"
          value="{{wifiData.encryption}}"
          range="{{['WPA', 'WEP', 'None']}}"
        >
          <view class="picker">
            {{wifiData.encryption}}
          </view>
        </picker>
      </view>
    </block>

    <block wx:elif="{{qrCodeType === 'contact'}}">
      <view class="form-item">
        <text class="form-label">å§“å</text>
        <input
          class="form-input"
          placeholder="è¾“å…¥è”ç³»äººå§“å"
          value="{{contactData.name}}"
          bindinput="onContactNameInput"
        />
      </view>
      <view class="form-item">
        <text class="form-label">ç”µè¯</text>
        <input
          class="form-input"
          placeholder="è¾“å…¥è”ç³»äººç”µè¯"
          value="{{contactData.phone}}"
          bindinput="onContactPhoneInput"
          type="number"
        />
      </view>
      <view class="form-item">
        <text class="form-label">é‚®ç®±</text>
        <input
          class="form-input"
          placeholder="è¾“å…¥è”ç³»äººé‚®ç®±"
          value="{{contactData.email}}"
          bindinput="onContactEmailInput"
        />
      </view>
      <view class="form-item">
        <text class="form-label">åœ°å€</text>
        <input
          class="form-input"
          placeholder="è¾“å…¥è”ç³»äººåœ°å€"
          value="{{contactData.address}}"
          bindinput="onContactAddressInput"
        />
      </view>
    </block>

    <view class="advanced-toggle" bindtap="toggleAdvancedOptions">
      <text>é«˜çº§é€‰é¡¹</text>
      <text class="toggle-icon">{{showAdvancedOptions ? 'â–²' : 'â–¼'}}</text>
    </view>

    <view class="advanced-options" wx:if="{{showAdvancedOptions}}">
      <view class="form-item">
        <text class="form-label">é¢œè‰²</text>
        <view class="color-picker">
          <color-picker bindchange="onColorChange" value="{{colorDark}}" />
          <view class="color-preview" style="background-color: {{colorDark}};"></view>
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">æ·»åŠ Logo</text>
        <switch checked="{{enableLogo}}" bindchange="toggleLogoOption" />
      </view>

      <view class="logo-section" wx:if="{{enableLogo}}">
        <button class="logo-btn" bindtap="chooseLogoImage">é€‰æ‹©Logoå›¾ç‰‡</button>
        <image wx:if="{{logoImage}}" class="logo-preview" src="{{logoImage}}" mode="aspectFit"></image>
      </view>
    </view>

    <view class="button-row">
      <button class="btn btn-clear" bindtap="clearInput">æ¸…ç©º</button>
      <button class="btn btn-generate" bindtap="generateQRCode" loading="{{isGenerating}}">
        {{isGenerating ? 'ç”Ÿæˆä¸­...' : 'ç”ŸæˆäºŒç»´ç '}}
      </button>
    </view>
  </view>

  <!-- QR Code Display Section -->
  <view class="qrcode-display" wx:if="{{qrCodeImage}}">
    <image class="qrcode-image" src="{{qrCodeImage}}" mode="aspectFit"></image>

    <view class="action-buttons">
      <button class="action-btn" bindtap="saveQRCode">
        <text class="action-icon">ğŸ’¾</text>
        <text>ä¿å­˜</text>
      </button>
      <button class="action-btn" bindtap="shareQRCode">
        <text class="action-icon">â†—ï¸</text>
        <text>åˆ†äº«</text>
      </button>
    </view>
  </view>

  <!-- History Toggle -->
  <view class="history-toggle" bindtap="toggleHistory">
    <text>å†å²è®°å½•</text>
    <text class="toggle-icon">{{showHistory ? 'â–²' : 'â–¼'}}</text>
  </view>

  <!-- History Section -->
  <view class="history-section" wx:if="{{showHistory}}">
    <view class="history-header">
      <text>å†å²è®°å½•</text>
      <text class="clear-history" bindtap="clearHistory">æ¸…ç©º</text>
    </view>

    <view class="history-list" wx:if="{{history.length > 0}}">
      <view class="history-item" wx:for="{{history}}" wx:key="id" bindtap="viewHistoryItem" data-id="{{item.id}}">
        <view class="history-info">
          <view class="history-type">
            <text wx:if="{{item.type === 'text'}}">æ–‡æœ¬</text>
            <text wx:elif="{{item.type === 'url'}}">ç½‘å€</text>
            <text wx:elif="{{item.type === 'wifi'}}">WiFi</text>
            <text wx:elif="{{item.type === 'contact'}}">è”ç³»äºº</text>
          </view>
          <view class="history-content">{{item.content}}</view>
          <view class="history-date">{{item.timestamp}}</view>
        </view>
        <view class="history-delete" catchtap="deleteHistoryItem" data-id="{{item.id}}">
          <text>Ã—</text>
        </view>
      </view>
    </view>

    <view class="empty-history" wx:else>
      <text>æš‚æ— å†å²è®°å½•</text>
    </view>
  </view>
</view>

<!-- WXS Module for Date Formatting -->
<wxs module="dateFormat">
  function formatTime(timestamp) {
    var date = getDate(timestamp);
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();

    return year + '-' + formatNumber(month) + '-' + formatNumber(day) + ' ' + formatNumber(hour) + ':' + formatNumber(minute);
  }

  function formatNumber(n) {
    n = n.toString();
    return n[1] ? n : '0' + n;
  }

  module.exports = {
    formatTime: formatTime
  };
</wxs>
